<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 1.6.2">
<meta name="crystal_docs.project_version" content="0.1.1">
<meta name="crystal_docs.project_name" content="base58">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="base58">
  <title>StringBuffer - base58 0.1.1</title>
  <script type="text/javascript">
    CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          base58
        </a>
      </h1>

      <span class="project-version">
        0.1.1
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class=" " data-id="base58/Array" data-name="array(t)">
      <a href="Array.html">Array</a>
      
    </li>
  
  <li class="parent " data-id="base58/Base58" data-name="base58">
      <a href="Base58.html">Base58</a>
      
        <ul>
  
  <li class="parent " data-id="base58/Base58/Alphabet" data-name="base58::alphabet">
      <a href="Base58/Alphabet.html">Alphabet</a>
      
        <ul>
  
  <li class=" " data-id="base58/Base58/Alphabet/Avalanche" data-name="base58::alphabet::avalanche">
      <a href="Base58/Alphabet/Avalanche.html">Avalanche</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Alphabet/Bitcoin" data-name="base58::alphabet::bitcoin">
      <a href="Base58/Alphabet/Bitcoin.html">Bitcoin</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Alphabet/Flickr" data-name="base58::alphabet::flickr">
      <a href="Base58/Alphabet/Flickr.html">Flickr</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Alphabet/IPFS" data-name="base58::alphabet::ipfs">
      <a href="Base58/Alphabet/IPFS.html">IPFS</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Alphabet/Monero" data-name="base58::alphabet::monero">
      <a href="Base58/Alphabet/Monero.html">Monero</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Alphabet/Polkadot" data-name="base58::alphabet::polkadot">
      <a href="Base58/Alphabet/Polkadot.html">Polkadot</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Alphabet/Ripple" data-name="base58::alphabet::ripple">
      <a href="Base58/Alphabet/Ripple.html">Ripple</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="base58/Base58/Base58Check" data-name="base58::base58check">
      <a href="Base58/Base58Check.html">Base58Check</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/CB58" data-name="base58::cb58">
      <a href="Base58/CB58.html">CB58</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Check" data-name="base58::check">
      <a href="Base58/Check.html">Check</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/Checksum" data-name="base58::checksum">
      <a href="Base58/Checksum.html">Checksum</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/ChecksumMismatch" data-name="base58::checksummismatch">
      <a href="Base58/ChecksumMismatch.html">ChecksumMismatch</a>
      
    </li>
  
  <li class="parent " data-id="base58/Base58/Decoder" data-name="base58::decoder">
      <a href="Base58/Decoder.html">Decoder</a>
      
        <ul>
  
  <li class=" " data-id="base58/Base58/Decoder/Into" data-name="base58::decoder::into">
      <a href="Base58/Decoder/Into.html">Into</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="base58/Base58/Encoder" data-name="base58::encoder">
      <a href="Base58/Encoder.html">Encoder</a>
      
        <ul>
  
  <li class=" " data-id="base58/Base58/Encoder/Into" data-name="base58::encoder::into">
      <a href="Base58/Encoder/Into.html">Into</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="base58/Base58/PointerCollection" data-name="base58::pointercollection">
      <a href="Base58/PointerCollection.html">PointerCollection</a>
      
    </li>
  
  <li class=" " data-id="base58/Base58/SS58" data-name="base58::ss58">
      <a href="Base58/SS58.html">SS58</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="base58/Benchmark" data-name="benchmark">
      <a href="Benchmark.html">Benchmark</a>
      
        <ul>
  
  <li class="parent " data-id="base58/Benchmark/IPS" data-name="benchmark::ips">
      <a href="Benchmark/IPS.html">IPS</a>
      
        <ul>
  
  <li class=" " data-id="base58/Benchmark/IPS/Entry" data-name="benchmark::ips::entry">
      <a href="Benchmark/IPS/Entry.html">Entry</a>
      
    </li>
  
  <li class=" " data-id="base58/Benchmark/IPS/Job" data-name="benchmark::ips::job">
      <a href="Benchmark/IPS/Job.html">Job</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="base58/StaticArray" data-name="staticarray(t, n)">
      <a href="StaticArray.html">StaticArray</a>
      
    </li>
  
  <li class=" " data-id="base58/String" data-name="string">
      <a href="String.html">String</a>
      
    </li>
  
  <li class=" current" data-id="base58/StringBuffer" data-name="stringbuffer">
      <a href="StringBuffer.html">StringBuffer</a>
      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1 class="type-name">

  <span class="kind">class</span> StringBuffer

</h1>


  <ul class="superclass-hierarchy"><li class="superclass"><a href="StringBuffer.html">StringBuffer</a></li><li class="superclass">Reference</li><li class="superclass">Object</li></ul>




  <h2>
    <a id="overview" class="anchor" href="#overview">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Overview
  </h2>

  <p>A StringBuffer is intended to be used as buffer for strings or binary data. Crystal does not
permit the String class to be subclassed, so the StringBuffer is implemented as a very light
wrapper around a String. It works by a String with a specific maximum capacity, which should
be larger than the largest piece of data that will be stored within it. The string's contents
will be changed by mutating the string's memory buffer and header information directly,
avoiding extra copying of data.</p>
<pre><code class="language-crystal">buffer <span class="o">=</span> <span class="t">StringBuffer</span>.new(<span class="n">256</span>)
buffer.mutate(<span class="s">&quot;Hello, world!&quot;</span>)
puts buffer <span class="c"># =&gt; &quot;Hello, world!&quot;</span>

buffer <span class="o">&lt;&lt;</span> <span class="s">&quot;This is a test.&quot;</span>
puts buffer <span class="c"># =&gt; &quot;This is a test.&quot;</span></code></pre>
<p>The StringBuffer will truncate any data that exceeds the capacity of its underlying string,
so there is no risk of the string's memory buffer being overrun.</p>














  <h2>
    <a id="defined-in" class="anchor" href="#defined-in">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Defined in:
  </h2>
  
    
      base58/extensions/string.cr
    
    <br/>
  





  <h2>
    <a id="constructors" class="anchor" href="#constructors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Constructors
  </h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#new%28string%3AString%29-class-method" class="signature"><strong>.new</strong>(string : String)</a>
        
          <div class="summary"><p>Initialize the buffer with a String.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#new%28slice%3ASlice%28UInt8%29%29-class-method" class="signature"><strong>.new</strong>(slice : Slice(UInt8))</a>
        
          <div class="summary"><p>Initialize the buffer with a Slice(UInt8).</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#new%28capacity%3AInt%3D256%29-class-method" class="signature"><strong>.new</strong>(capacity : Int = <span class="n">256</span>)</a>
        
          <div class="summary"><p>Initialize the buffer with a specific capacity, but do nothing to clear the underlying memory buffer.</p></div>
        
      </li>
    
  </ul>





  <h2>
    <a id="instance-method-summary" class="anchor" href="#instance-method-summary">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Instance Method Summary
  </h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#%3C%3C%28val%29-instance-method" class="signature"><strong>#<<</strong>(val)</a>
        
          <div class="summary"><p>Shorthand, convenience method for <code><a href="StringBuffer.html#mutate%28val%29-instance-method">#mutate</a></code>.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#buffer%3AString-instance-method" class="signature"><strong>#buffer</strong> : String</a>
        
          <div class="summary"><p>Returns the underlying String.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#capacity%3AInt32-instance-method" class="signature"><strong>#capacity</strong> : Int32</a>
        
      </li>
    
      <li class="entry-summary">
        <a href="#header-instance-method" class="signature"><strong>#header</strong></a>
        
          <div class="summary"><p>Retuns the object header of the underlying String.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#mutate%28val%29-instance-method" class="signature"><strong>#mutate</strong>(val)</a>
        
          <div class="summary"><p>This method takes a memory buffer referenced by a Pointer(UInt8), and encodes it into an existing String.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#to_s%28io%3AIO%29-instance-method" class="signature"><strong>#to_s</strong>(io : IO)</a>
        
          <div class="summary"><p>Outputs the contents of the underlying String to the given IO.</p></div>
        
      </li>
    
      <li class="entry-summary">
        <a href="#to_unsafe-instance-method" class="signature"><strong>#to_unsafe</strong></a>
        
          <div class="summary"><p>Returns a Pointer(UInt8) to the underlying String's data.</p></div>
        
      </li>
    
  </ul>



  <h2>
    <a id="macro-summary" class="anchor" href="#macro-summary">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Macro Summary
  </h2>
  <ul class="list-summary">
    
      <li class="entry-summary">
        <a href="#method_missing%28call%29-macro" class="signature"><strong>method_missing</strong>(call)</a>
        
      </li>
    
  </ul>



<div class="methods-inherited">
  
    


    


    


  
    


    


    


  
</div>


  <h2>
    <a id="constructor-detail" class="anchor" href="#constructor-detail">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Constructor Detail
  </h2>
  
    <div class="entry-detail" id="new(string:String)-class-method">
      <div class="signature">
        
        def self.<strong>new</strong>(string : <a href="String.html">String</a>)

        <a class="method-permalink" href="#new%28string%3AString%29-class-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Initialize the buffer with a String.</p>
<pre><code class="language-crystal">buffer <span class="o">=</span> <span class="t">StringBuffer</span>.new(<span class="s">&quot;0x00&quot;</span> <span class="o">*</span> <span class="n">256</span>)</code></pre>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="new(slice:Slice(UInt8))-class-method">
      <div class="signature">
        
        def self.<strong>new</strong>(slice : Slice(UInt8))

        <a class="method-permalink" href="#new%28slice%3ASlice%28UInt8%29%29-class-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Initialize the buffer with a Slice(UInt8).</p>
<pre><code class="language-crystal">buffer <span class="o">=</span> <span class="t">StringBuffer</span>.new(<span class="t">Slice</span>(<span class="t">UInt8</span>).new(<span class="n">256</span>, <span class="n">0</span>))</code></pre>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="new(capacity:Int=256)-class-method">
      <div class="signature">
        
        def self.<strong>new</strong>(capacity : Int = <span class="n">256</span>)

        <a class="method-permalink" href="#new%28capacity%3AInt%3D256%29-class-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Initialize the buffer with a specific capacity, but do nothing to clear the underlying
memory buffer. Until data is assigned to the buffer, it's contents will be undefined
and meaningless.</p>
<pre><code class="language-crystal">buffer <span class="o">=</span> <span class="t">StringBuffer</span>.new(<span class="n">256</span>)
pp buffer.buffer.to_slice[<span class="n">0</span>, <span class="n">8</span>] <span class="c"># =&gt; Bytes[0, 0, 27, 28, 33, 0, 0, 0]</span></code></pre>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  





  <h2>
    <a id="instance-method-detail" class="anchor" href="#instance-method-detail">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Instance Method Detail
  </h2>
  
    <div class="entry-detail" id="&lt;&lt;(val)-instance-method">
      <div class="signature">
        
        def <strong><<</strong>(val)

        <a class="method-permalink" href="#%3C%3C%28val%29-instance-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Shorthand, convenience method for <code><a href="StringBuffer.html#mutate%28val%29-instance-method">#mutate</a></code>.</p>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="buffer:String-instance-method">
      <div class="signature">
        
        def <strong>buffer</strong> : <a href="String.html">String</a>

        <a class="method-permalink" href="#buffer%3AString-instance-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Returns the underlying String.</p>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="capacity:Int32-instance-method">
      <div class="signature">
        
        def <strong>capacity</strong> : Int32

        <a class="method-permalink" href="#capacity%3AInt32-instance-method">#</a>
      </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="header-instance-method">
      <div class="signature">
        
        def <strong>header</strong>

        <a class="method-permalink" href="#header-instance-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Retuns the object header of the underlying String. Like <code><a href="StringBuffer.html#to_unsafe-instance-method">#to_unsafe</a></code>, this method
is exposed because other internals use it, but it's unlikley that you will want or
need to use it directly.</p>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="mutate(val)-instance-method">
      <div class="signature">
        
        def <strong>mutate</strong>(val)

        <a class="method-permalink" href="#mutate%28val%29-instance-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>This method takes a memory buffer referenced by a Pointer(UInt8), and encodes it into an existing String. It may be useful to understand how
this works, however, so pull up a chair and a drink, dear reader, and we'll have a short chat.</p>
<p>A String, in Crystal, is represented by four in-memory pieces of data. These are a Type ID, a byte size, a character size, and the bytes of
data that comprise the actual string.</p>
<p><code>| Type ID | Byte Size | Character Size | Bytes |</code></p>
<p>The first three of those, taken together, represent the String header. The String class holds an
<a href="https://github.com/crystal-lang/crystal/blob/29f9ac503/src/string.cr#L142">undocumented constant</a>, <code>String::HEADER_SIZE</code>,
which is the size of the header, in bytes.</p>
<p>When a String is initially created, a memory buffer of <code>HEADER_SIZE + capacity</code> is allocated, where <code><a href="StringBuffer.html#capacity%3AInt32-instance-method">#capacity</a></code> is the maximum number
of bytes that the String can hold.</p>
<p>The <code>HEADER_SIZE</code> is used as an offset into this buffer to point to the part of the buffer which will hold the bytes of string data,
and that data is inserted into memory starting with that offset.</p>
<p>To finalize the String's memory buffer, a header is written into the first <code>HEADER_SIZE</code> bytes of the buffer, which contains the
Type ID, the byte size, and the character size of the string.</p>
<p>Because this is just data in memory, it is possible to access it directly, and manipulate it. Also, a String still works just fine if
the allocated memory for it is larger than what is actually used to store the header plus the string data. This provides an opportunity
to directly mutate a String.</p>
<p>If the data after the <code>HEADER_SIZE</code> offset is changed, the string is changed. However, if the amount of data changes, the header must
also be updated to reflect the new size of the string. That header is just bytes, though, so it can be rewritten.</p>
<pre><code class="language-crystal">header <span class="o">=</span> string.<span class="k">as</span>({<span class="t">Int32</span>, <span class="t">Int32</span>, <span class="t">Int32</span>}<span class="o">*</span>)                          <span class="c"># Effectively extracts the header from the String as a Pointer({Int32, Int32, Int32}).</span>
header.value <span class="o">=</span> {<span class="t">String</span><span class="t">::</span><span class="t">TYPE_ID</span>, new_byte_size, new_character_size} <span class="c"># Rewrites the header. MUST NOT exceed original byte_size.</span></code></pre>
<p>As mentioned in the comments above, the new data that is inserted into the buffer must not exceed it's original size. If it does,
at best, something else might come along later and stomp on that data, but more likely, the program will crash:</p>
<pre><code class="language-crystal"><span class="t">Invalid</span> memory access (signal <span class="n">11</span>) at address <span class="n">0x168b0ae</span></code></pre>
<p>This limitation is because the <code>GC.realloc</code> call, which can be used to resize an allocation to a smaller or a larger size, does not
guarantee that, in the case of a larger allocation, the allocation will remain in the same location. If the memory does not have enough
free space to increase the size of the allocation, <code>realloc</code> will copy the contents of the old buffer to the new location, and then
free the old location. If this happens, however, your program's other code won't realize that the string is now in a different location,
and when an effort to access it happens, it will access the old location, which will no longer be valid, likely resulting in your program
crashing.</p>
<p>So... don't do that. Within the limitation regarding not exceeding the original size of the String, however, it appears to work flawlessly.</p>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="to_s(io:IO)-instance-method">
      <div class="signature">
        
        def <strong>to_s</strong>(io : IO)

        <a class="method-permalink" href="#to_s%28io%3AIO%29-instance-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Outputs the contents of the underlying String to the given IO.</p>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  
    <div class="entry-detail" id="to_unsafe-instance-method">
      <div class="signature">
        
        def <strong>to_unsafe</strong>

        <a class="method-permalink" href="#to_unsafe-instance-method">#</a>
      </div>
      
        <div class="doc">
          
          <p>Returns a Pointer(UInt8) to the underlying String's data. This method is exposed
because other internals use it, but it's unlikley that you will want or need to use
it directly.</p>
        </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  



  <h2>
    <a id="macro-detail" class="anchor" href="#macro-detail">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>
    Macro Detail
  </h2>
  
    <div class="entry-detail" id="method_missing(call)-macro">
      <div class="signature">
        
        macro <strong>method_missing</strong>(call)

        <a class="method-permalink" href="#method_missing%28call%29-macro">#</a>
      </div>
      
      <br/>
      <div>
        
      </div>
    </div>
  


</div>

</body>
</html>
